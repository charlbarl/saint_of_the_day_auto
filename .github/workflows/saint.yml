name: Update Saint of the Day JSON

on:
  schedule:
    - cron: "5 6 * * *"  # runs daily at 06:05 UTC (← comment fixed)
  workflow_dispatch:
  push:
    branches:
      - main

# Ensure the workflow's GITHUB_TOKEN can write to the repo
permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest
    env:
      NEOCITIES_USER: ${{ secrets.NEOCITIES_USER }}
      NEOCITIES_API_KEY: ${{ secrets.NEOCITIES_API_KEY }}
      # Do NOT redefine GITHUB_TOKEN here; GitHub provides it automatically.

    steps:
      # 1️⃣ Checkout repo with credentials
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # default persist-credentials: true (keep it)

      # 2️⃣ Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3️⃣ Install dependencies
      # TIP: Prefer committing a package.json and using `npm ci`.
      - name: Install dependencies
        run: npm install fast-xml-parser

      # 4️⃣ Run fetch_saints.js to generate JSON
      - name: Run fetch_saints.js
        run: node scripts/fetch_saints.js

      # 5️⃣ Debug: list JSON file
      - name: "Debug: list assets/data/"
        run: |
          pwd
          ls -R assets/data

      # 6️⃣ Commit updated JSON back to GitHub
      - name: Commit and push updated JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add assets/data/saint_of_day.json

          # Only commit if changes exist
          if ! git diff --cached --quiet; then
            git commit -m "Update Saint of the Day JSON [ci skip]"
            # Push to main (will succeed if permissions + no blocking branch protection)
            git push origin HEAD:main
          else
            echo "No changes to commit."
          fi

      # 7️⃣ Upload JSON to Neocities
      - name: Upload saint_of_day.json to Neocities
        run: |
          # Neocities expects the field name 'file' (your next debug step already uses it)
          curl --fail \
            --user "$NEOCITIES_USER:$NEOCITIES_API_KEY" \
            -F "file=@assets/data/saint_of_day.json" \
            https://neocities.org/api/upload

      - name: Debug env & file
        run: |
          echo "User length: ${#NEOCITIES_USER}"
          echo "API key length: ${#NEOCITIES_API_KEY}"
          ls -l assets/data/saint_of_day.json
          curl -v --user "$NEOCITIES_USER:$NEOCITIES_API_KEY" \
               -F "file=@assets/data/saint_of_day.json" \
               https://neocities.org/api/upload
